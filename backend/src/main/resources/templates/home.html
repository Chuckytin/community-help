<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Inicio - Ayuda Comunitaria</title>
    <!-- Bootstrap CSS (WebJars) -->
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.3.6/css/bootstrap.min.css}"/>
    <!-- Leaflet CSS (Mapas) -->
    <link rel="stylesheet" th:href="@{/webjars/leaflet/1.9.4/dist/leaflet.css}"/>
    <!-- Font Awesome (Iconos) -->
    <link rel="stylesheet" th:href="@{/webjars/font-awesome/6.7.2/css/all.min.css}"/>
    <style>
        body {
            background-color: #f8f9fa;
        }
        .user-card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        #map {
            height: 400px;
            border-radius: 10px;
        }
    </style>
</head>
<body>
<!-- Barra de navegación -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="/home">Ayuda Comunitaria</a>
        <div class="navbar-nav ms-auto">
            <span class="navbar-text me-3">
                Hola, <span th:text="${user.name}">Usuario</span>!
            </span>
            <a class="btn btn-outline-light" href="#" th:href="@{/logout}">
                <i class="fas fa-sign-out-alt"></i> Cerrar sesión
            </a>
        </div>
    </div>
</nav>

<!-- Contenido principal -->
<div class="container py-4">
    <div class="row">
        <!-- Tarjeta de usuario -->
        <div class="col-md-4 mb-4">
            <div class="card user-card">
                <div class="card-body text-center">
                    <!-- Imagen de perfil - funciona para ambos tipos de login -->
                    <img th:if="${authAttributes?.picture}"
                         th:src="${authAttributes?.picture}"
                         th:unless="${authAttributes?.picture == null}"
                         src="/images/default-user.png"
                         class="rounded-circle mb-3" width="100" alt="Foto perfil">

                    <h5 th:text="${user.name}">Nombre Usuario</h5>
                    <p class="text-muted" th:text="${user.email}">email@ejemplo.com</p>

                    <a th:href="@{/request/new}" class="btn btn-primary w-100 mb-2">
                        <i class="fas fa-plus"></i> Crear solicitud
                    </a>
                    <a th:href="@{/requests}" class="btn btn-outline-secondary w-100">
                        <i class="fas fa-list"></i> Ver mis solicitudes
                    </a>
                </div>
            </div>
        </div>

        <!-- Mapa y solicitudes cercanas -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="fas fa-map-marker-alt"></i> Solicitudes cercanas</h5>
                </div>
                <div class="card-body p-0">
                    <div id="map"></div>
                    <div th:if="${warning}" class="alert alert-warning m-3" th:text="${warning}"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script th:src="@{/webjars/bootstrap/5.3.6/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/webjars/leaflet/1.9.4/dist/leaflet.js}"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    const user = {
        id: [[${user?.id}]],
        name: [[${user?.name}]],
        email: [[${user?.email}]],
        phoneNumber: [[${user?.phoneNumber}]],
        latitude: [[${user?.latitude}]],
        longitude: [[${user?.longitude}]],
        picture: [[${authAttributes?.picture}]] || '/images/default-user.png'
    };

    // Verificación segura de ubicación
    if (user.latitude && user.longitude) {
        // Inicializar mapa
        const map = L.map('map').setView([user.latitude, user.longitude], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // Marcador del usuario
        L.marker([user.latitude, user.longitude])
            .bindPopup(`<b>${user.name}</b><br>Tu ubicación`)
            .addTo(map);

        // Marcadores de solicitudes
        const requests = [[${requests}]] || [];
        requests.forEach(request => {
            if (request.x && request.y) {
                L.marker([request.y, request.x])
                    .bindPopup(`
                        <b>${request.title || 'Sin título'}</b><br>
                        <small>${request.category || 'Sin categoría'}</small><br>
                        <span>Distancia: ${request.distance ? (request.distance / 1000).toFixed(2) + ' km' : 'N/A'}</span>
                    `)
                    .addTo(map);
            }
        });
    } else {
        console.warn("Ubicación del usuario no disponible para mostrar el mapa");
    }
    /*]]>*/
</script>
</body>
</html>